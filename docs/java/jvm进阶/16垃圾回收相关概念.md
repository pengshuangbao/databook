# 第十六章、垃圾回收相关概念

[toc]

## System.gc的理解

![image](https://static.lovedata.net/20-12-25-0f8e8b8c1c4199d1b348d43af8c610f1.png-wm)

### 手动调用System.gc理解不可达对象的回收行为

```java
public class LocalVarGC {
    public void localvarGC1() {
        byte[] buffer = new byte[10 * 1024 * 1024];//10MB
        System.gc();
    }

    public void localvarGC2() {
        byte[] buffer = new byte[10 * 1024 * 1024];
        buffer = null;
        System.gc();
    }

    public void localvarGC3() {
        {
            byte[] buffer = new byte[10 * 1024 * 1024];
        }
        System.gc();
    }

    public void localvarGC4() {
        {
            byte[] buffer = new byte[10 * 1024 * 1024];
        }
        int value = 10;
        System.gc();
    }

    public void localvarGC5() {
        localvarGC1();
        System.gc();
    }

    public static void main(String[] args) {
        LocalVarGC local = new LocalVarGC();
        local.localvarGC5();
    }
}
```

#### localvarGC1

没有触发GC，新生代没有回收掉，full gc后新生代归零，放入到老年代

![image](https://static.lovedata.net/20-12-25-873c79d727931248a253c34a7903cf9a.png-wm)

![image-20201225091851191](/Users/apple/Library/Application Support/typora-user-images/image-20201225091851191.png)



#### localvarGC2

full gc 的时候 已经回收了

![image](https://static.lovedata.net/20-12-25-ee329f579e3d2ee010251dca68588e3c.png-wm)

#### localvarGC2

full gc的时候，没有被回收掉，为什么？



![image](https://static.lovedata.net/20-12-25-05cc5ffcf74a05ef6063804b2f4e021d.png-wm)

为什么？

局部变量表的长度是2，但是局部变量表里面只有一个this，索引为0的是this，索引为1的其实就是buffer，还占用着1这个位置，回收的时候就不会回收了

![image](https://static.lovedata.net/20-12-25-18a615a28a5b5921459054bf6ccd3cb0.png-wm)

![image](https://static.lovedata.net/20-12-25-af90c3d7720c943e39ae4e5a3e6e576e.png-wm)

#### localvarGC4

buffer已经回收了



![image](https://static.lovedata.net/20-12-25-83c8f9c1536220440f31e4988986882e.png-wm)

![image](https://static.lovedata.net/20-12-25-f9fb1352d8605dcda1d106b727ccbdac.png-wm)



![image](https://static.lovedata.net/20-12-25-e8b9c0653d1ae9cb942724e5ac35a392.png-wm)

局部变量表的长度还是2，索引为1的地方一开始还是 buffer，后来被value占据了，所以buffer就被回收了，。

localvarGC5

![image](https://static.lovedata.net/20-12-28-82e56954b537eda2517dcf7f882ea379.png-wm)



## 内存溢出和内存泄漏

### 内存溢出

![image](https://static.lovedata.net/20-12-28-e987d4bc85462e05f3fd3d5357f06e7f.png-wm)

![image](https://static.lovedata.net/20-12-28-82faae5752e1f8368af5740e73a43564.png-wm)

![image](https://static.lovedata.net/20-12-28-6e33ec137aa85a31c4eca456ded78be8.png-wm)

### 内存泄漏

![image](https://static.lovedata.net/20-12-28-6adafae24a5e7b370ea2056cd3c9a697.png-wm)

![image](https://static.lovedata.net/20-12-28-90bb213fb7d9b33ac05e56aebae54e91.png-wm)

> 右图右上角 对象不用了，但是无法回收，有一根线

### 内存泄漏举例

![image](https://static.lovedata.net/20-12-28-4016996f25fbd5fa3cc3d0dd5fff4d18.png-wm)

## Stop the world

> GC root 是不断变化的

![image](https://static.lovedata.net/20-12-28-465d079882bbbd4937e33a41d0703753.png-wm)



![image](https://static.lovedata.net/20-12-28-62a74f670b61e7b54b3a56db46af4de7.png-wm)

## 垃圾回收的并行与并发

### 程序的并行与并发

![image](https://static.lovedata.net/20-12-28-98f1f5eba8b7ce1dd74c22451a5b7fe0.png-wm)



![image](https://static.lovedata.net/20-12-28-e82de90845bd7a3cdfb4ce06ad0686f5.png-wm)



![image](https://static.lovedata.net/20-12-28-a566fda2107e022abdf028355c6d98f8.png-wm)

### 垃圾回收的并行与并发

![image](https://static.lovedata.net/20-12-28-87bc9ce8993afb755fd1eba87e137e02.png-wm)



![image](https://static.lovedata.net/20-12-28-9d7de95d606aa9229e2627a3784d3021.png-wm)





## 安全点与安全区域

### 安全点

![image](https://static.lovedata.net/20-12-28-d865a02be69aceff40ddf74ef42ad8c9.png-wm)

![image](https://static.lovedata.net/20-12-28-e58207c57aadd63a3418b268d81d2b56.png-wm)

### 安全区域

![image](https://static.lovedata.net/20-12-28-ca316f8fed771259bf3b05ef4892c8fa.png-wm)



![image](https://static.lovedata.net/20-12-28-bee3aac5102fbb9dd389ef5a954cd0de.png-wm)

## 再谈引用：强引用-不回收

### 强-> 软-> 弱 -> 虚

![image](https://static.lovedata.net/20-12-29-15e7bc00073086aa18ade5a9718a79f9.png-wm)

![image](https://static.lovedata.net/20-12-29-6c27340f01467a985e77e9909ffdf61e.png-wm)



![image](https://static.lovedata.net/20-12-29-f7397bcd214a7f585645fb18e4247f29.png-wm)



![image](https://static.lovedata.net/20-12-29-733ec735170184d63daa399fb7a95989.png-wm)



![image](https://static.lovedata.net/20-12-29-e1b608ad66398334877e4a6df5ad2e4e.png-wm)



![image](https://static.lovedata.net/20-12-29-ce7c96429b3aa10e677d34e4db2d0d17.png-wm)



## 再谈引用：软引用-内存不足即回收

![image](https://static.lovedata.net/20-12-29-b2afb08f07fbc934b93acae04f2d91fe.png-wm)

![image](https://static.lovedata.net/20-12-29-27d0f47b036f2029569e3eb8997a6a72.png-wm)



> 内存足够，不会清楚软引用

![image](https://static.lovedata.net/20-12-29-5ce2cc04f7ad60e1b589bf4357d73b1d.png-wm)

![image](https://static.lovedata.net/20-12-29-09704bff9275027873ea147d4dfd3984.png-wm)

## 再谈引用：弱引用-发现即回收

![image](https://static.lovedata.net/20-12-29-1a6b4b847e06578e1270f17ef549948c.png-wm)

![image](https://static.lovedata.net/20-12-29-7f5cbe722d3601231d61e28e53c1a63a.png-wm)

### WeakHashMap

内部的Entry继承了WeakReference

![image](https://static.lovedata.net/20-12-29-b60a8553ee376ab7e600aad239a50d2d.png-wm)

### 举例

![image](https://static.lovedata.net/20-12-29-97cd065157c225a7c34e8aa3060fbb2f.png-wm)

## 谈引用：虚引用

![image](https://static.lovedata.net/20-12-29-ece4925a6c070ced93316a04ec739c12.png-wm)



![image](https://static.lovedata.net/20-12-29-049d195a42b46423f8d64c6ccc0432ff.png-wm)



## 再谈引用：终结器引用
# 第十七章、垃圾回收器

[toc]

## GC分类与性能指标

![image](https://static.lovedata.net/20-12-30-3ba42ec896747fcb7e7fd9e3d4b17ae0.png-wm)



![image](https://static.lovedata.net/20-12-30-dc0374d5867e9efdb51102d91010dbf6.png-wm)



### 垃圾回收器分类

#### 按照线程数分类

![image](https://static.lovedata.net/20-12-30-e7581ce2bc0e263db793f5bffdbb29d6.png-wm)



![image](https://static.lovedata.net/20-12-30-abee3db08b05ca7755a09f0b3063d26a.png-wm)

#### 按照工作模式

![image](https://static.lovedata.net/20-12-30-ff3f35845b7b2f54aa4c4c06115c7462.png-wm)

#### 按照碎片处理方式分

![image](https://static.lovedata.net/20-12-30-0eebc3223549270904867673f2af4291.png-wm)

### 评估垃圾回收器性能指标

![image](https://static.lovedata.net/20-12-30-854cdd2b9ef485452d20671788d7251e.png-wm)

![image](https://static.lovedata.net/20-12-30-1c6c469b9bfcd5dafee058ca9689c23e.png-wm)

### 吞吐量

> 注重吞吐量，用户代码运行的事件越长越好，不在意一次gc的暂停时间，注重在单位时间内，stw的时间最短

![image](https://static.lovedata.net/20-12-30-81dd85b48fa05885d91599967708ac29.png-wm)



![image](https://static.lovedata.net/20-12-30-28bbdc8444f026df8db956dc6521e21e.png-wm)



### 暂停时间(注重低延迟)

> 每次暂停时间短，但是回收次数比较多,尽可能让每次stw的时间最短

![image](https://static.lovedata.net/20-12-30-35df5a9dbc2424f141c52a8b8190b5fd.png-wm)



>  吞吐量和暂停时间是一对矛盾体

![image](https://static.lovedata.net/20-12-30-e6bb0e9cc380297c3524c0acf7169243.png-wm)



![image](https://static.lovedata.net/20-12-31-70e0ea74b4e8ef445d7329331fa82cfa.png-wm)

G1的标准：在最大吞吐量优先的情况下，降低吞吐量，在可控的时间范围之内，比如10ms，极可能的提交吞吐量。



## 不同垃圾回收器概述

![image](https://static.lovedata.net/20-12-31-6a6fe35edd31c6cd98495e740ad29f9b.png-wm)

![image](https://static.lovedata.net/20-12-31-c9f7e43bfc8484a3a471b95787ba3c67.png-wm)



### 7款经典垃圾回收器

![image](https://static.lovedata.net/20-12-31-0f8e8b8c1c4199d1b348d43af8c610f1.png-wm)



![image](https://static.lovedata.net/20-12-31-729594fa70e38192d92b617ad8c22c06.png-wm)



### 七款垃圾回收器和垃圾分代之间的关系

![image](https://static.lovedata.net/20-12-31-99f4af02f00ee5b956f7cdfc2f2fad3c.png-wm)

### 垃圾收集器的组合关系

![image](https://static.lovedata.net/20-12-31-0ce3e89aed0fc3d9f1f0a3a8b09a0922.png-wm)



> 后备方案，cms是并发的，需要提前回收，垃圾回收的同时，用户线程还在执行，用户还在制造垃圾 。如果回收的比较晚了，活着垃圾制造的速度比垃圾回收还要快，会出现失败情况，失败了，则使用Serial old作为后备方案，触发Full GC， 停止用户线程。

![image](https://static.lovedata.net/20-12-31-76010eb30f388c4b69473290c1b074bd.png-wm)



> 这两个组合，在jdk8中标记为deprecated，在jdk9中，直接删除了

![image](https://static.lovedata.net/20-12-31-4b1e5637739f758994e1313ee55399fb.png-wm)

![image](https://static.lovedata.net/20-12-31-89133872f1c6b356a0215b5fde1baa77.png-wm)

> 疑问：为什么CMS不能和Parallel Scavenge GC 组合使用？
>
> 答：因为底层使用的垃圾回收框架不同，导致无法兼容，却能和ParNew GC 组合使用，性能上ParNew和Parallel Scavenge G差不太多

### 为什么需要这么多垃圾收集器？

![image](https://static.lovedata.net/20-12-31-3689ebe8594a9bbeb130523c01eb4267.png-wm)

### 默认垃圾回收器

![image](https://static.lovedata.net/21-01-03-883060c0b4db25dace771b1823299af8.png-wm)



#### JDK8默认是使用Parallel Scavage 回收器，老年代也就默认配套使用Parallel Old GC

![image](https://static.lovedata.net/21-01-03-33a8d643caf826f97a1aa9e8bc55bb42.png-wm)

![image](https://static.lovedata.net/21-01-03-e9386120bbd7eb1a536bb0e88dd9e1d4.png-wm)

#### JDK9默认使用G1

![image](https://static.lovedata.net/21-01-03-dfa50b0d6940f63273c903d1d745db9e.png-wm)

![image](https://static.lovedata.net/21-01-03-a962c03992d44723434a6192855c5919.png-wm)

## Serial回收器：串行回收

![image](https://static.lovedata.net/21-01-03-13de8f7b3791a23b5a487ea7440e0304.png-wm)

![image](https://static.lovedata.net/21-01-03-ec4be9159b6ac5c134bb6f0000399987.png-wm)

![image](https://static.lovedata.net/21-01-03-f327a8dd69decacbd47a7e388731f788.png-wm)

![image](https://static.lovedata.net/21-01-03-53e314182cc82eab45f3a7f9385d92ce.png-wm)

![image](https://static.lovedata.net/21-01-03-cd624647a4f5dce9fbcae2e88163c239.png-wm)

## ParNew回收器：并行回收

![image](https://static.lovedata.net/21-01-03-8deb78908ae54d82968cbfc523bc0571.png-wm)

![image](https://static.lovedata.net/21-01-03-e0eac9cd7764a18d12becc795b4ccb05.png-wm)

![image-20210103100712756](/Users/apple/Library/Application Support/typora-user-images/image-20210103100712756.png)

![image](https://static.lovedata.net/21-01-03-c1d34fd77cba5de8ebb59575563f8146.png-wm)

#### JDK9已经Deprecated

![image](https://static.lovedata.net/21-01-03-7ac04afad16fadc0957620bb0bd626a2.png-wm)

#### JDK8

![image](https://static.lovedata.net/21-01-03-ce3d30992584d17254bd27be15ed708d.png-wm)

![image](https://static.lovedata.net/21-01-03-60415cb57107f5e335f663714d9a31ee.png-wm)

![image](https://static.lovedata.net/21-01-03-d58446d675891e5e9972b4d6e81778fb.png-wm)

![image](https://static.lovedata.net/21-01-03-7a83b38b3f8e7ab5500bf20cb9bb0d9b.png-wm)



## Parallel回收器：吞吐量优先

#### 自适应调节策略是Parallel和ParNew的一个重要区别

![image](https://static.lovedata.net/21-01-03-80ab22efde21111d9974c0fb461ed2a6.png-wm)

![image](https://static.lovedata.net/21-01-03-5c90ade92b27555240d8574dbe7d6433.png-wm)

![image](https://static.lovedata.net/21-01-03-e1224755ac54539d037c0c68cd42ee4e.png-wm)

![image](https://static.lovedata.net/21-01-03-7eb779a6a587b3355d8a3758d1ca5953.png-wm)

![image](https://static.lovedata.net/21-01-03-5589d5c7e117ed1bb02b04a5ecf48985.png-wm)

![image](https://static.lovedata.net/21-01-03-dcc2175b84bd40771d3e8c43c6215f43.png-wm)

![image](https://static.lovedata.net/21-01-03-602e9b8282d0a3546ac4b7f753116f54.png-wm)

![image](https://static.lovedata.net/21-01-03-e957ae5690d0dba7562236147fd5f3d8.png-wm)

## CMS回收器：低延迟

![image](https://static.lovedata.net/21-01-03-0988e0f0b9003df376cb43d45c270cd7.png-wm)

![image](https://static.lovedata.net/21-01-03-14f1c0b37372177c133e45b598811696.png-wm)

### 工作原理

![image](https://static.lovedata.net/21-01-03-d5e01b034df295c54e71ca5d7269a8aa.png-wm)



![image](https://static.lovedata.net/21-01-03-26a53860266340a653a7c875470df65f.png-wm)

![image-20210103104139722](/Users/apple/Library/Application Support/typora-user-images/image-20210103104139722.png)

### 优缺点

![image](https://static.lovedata.net/21-01-03-387f523784a2d04f306ec08769871acb.png-wm)

![image](https://static.lovedata.net/21-01-03-099e8f0dc8ac195baa75769e59b172f1.png-wm)

![image](https://static.lovedata.net/21-01-03-e6ebad618a9d6ac84a2b8bf98c2180a8.png-wm)

![image](https://static.lovedata.net/21-01-03-38f29f86bc4949da224a97cb3fe7addf.png-wm)

### 参数配置

![image](https://static.lovedata.net/21-01-03-2f1df6bf4d1d48045b1c67ff7529f03e.png-wm)

![image](https://static.lovedata.net/21-01-03-96e76a9c4cdaafd289f092fe7aa166cb.png-wm)

### 小结

![image](https://static.lovedata.net/21-01-03-f686eb4e44404d3c8f910836fb3c0cec.png-wm)

### CMS后续的变化

![image](https://static.lovedata.net/21-01-03-1184850925fee4b8679baca99709a132.png-wm)

## G1回收器：区域化分代式

### G1出现的原因

![image](https://static.lovedata.net/21-01-03-f51410592a87ad733b8b91c7634b36c1.png-wm)

### 为什么叫G1

![image](https://static.lovedata.net/21-01-03-37e9375e1ebe233587d37236fcf7dc35.png-wm)

### G1区域分代化

![image](https://static.lovedata.net/21-01-03-17779940c8769b96a9dccbd4f0db68c3.png-wm)

### G1特点和优势

![image](https://static.lovedata.net/21-01-03-e0ccfe6c3bbd80b2e44591e4f06762ed.png-wm)



![image](https://static.lovedata.net/21-01-03-751861363df6d977d77c512dbc0a3da9.png-wm)

#### 空间整合

![image](https://static.lovedata.net/21-01-03-869c98c0ca49cd9bdb7e1cb3eef5f336.png-wm)

![image](https://static.lovedata.net/21-01-03-b848390551d77bb3a59c5e06b7309398.png-wm)



### G1缺点

![image](https://static.lovedata.net/21-01-03-87e075113234a504f14d917f35768c9a.png-wm)

### G1参数设置

- -XX:InitiatingHeapOccupancyPercent=*percent*

  Sets the percentage of the heap occupancy (0 to 100) at which to start a concurrent GC cycle. It is used by garbage collectors that trigger a concurrent GC cycle based on the occupancy of the entire heap, not just one of the generations (for example, the G1 garbage collector).

  By default, the initiating value is set to 45%. A value of 0 implies nonstop GC cycles. The following example shows how to set the initiating heap occupancy to 75%:

  ```
  -XX:InitiatingHeapOccupancyPercent=75
  ```

![image](https://static.lovedata.net/21-01-03-6ebddb4ebdc4e4aa68d18ed83c1db73b.png-wm)



### G1常见操作步骤

![image](https://static.lovedata.net/21-01-03-a4d9c0ca2d8e538c63a078f6968dae87.png-wm)

### G1适用场景

![image](https://static.lovedata.net/21-01-03-773ded4365071c87f202dc8eaf31c8fe.png-wm)

### G1 Region分代-化整为0

![image](https://static.lovedata.net/21-01-03-53dd7a8eaa0f4bb6304af5f026717c5d.png-wm)

![image](https://static.lovedata.net/21-01-03-559c235dbba15d0d0ca232ab0acad9cb.png-wm)

![image](https://static.lovedata.net/21-01-03-2e1e55eed6b4331ae8ba9aab5fc20880.png-wm)

![image](https://static.lovedata.net/21-01-03-8e21ab4231d3cf6ab86a2bd647b51e20.png-wm)

### G1主要回收过程

![image](https://static.lovedata.net/21-01-03-bec1c8558f8beb3571ba456bc33e97b7.png-wm)



![image](https://static.lovedata.net/21-01-03-129da2f7bfa82cf9a91905e189fffcfe.png-wm)

![image](https://static.lovedata.net/21-01-03-a174ca0739ef765bfe53aec5c3958bae.png-wm)

### Remmenbered Set（Rset）记忆集

![image](https://static.lovedata.net/21-01-03-0e9bb9badc6e0ab562af13fb24bc9bd5.png-wm)

> 一个对象，可能被不同的区域的引用所引用哦，如果需要判断一个对象是否存活，如果没有记忆集，则需要遍历所有的我区域才能判断是否存活

![image](https://static.lovedata.net/21-01-03-948f16aecc36d3d405e493a03c82013b.png-wm)



如下图，每个Region 都有一个记忆集，记录着其他Region对这个region的引用，如果想对这个Region2进行垃圾回收，则用不着对全堆进行遍历了。直接看记忆集合就行了

![image](https://static.lovedata.net/21-01-03-7dd9ee8ad5176ec66ce4dd793f62ae6d.png-wm)

#### 补充

![image](https://static.lovedata.net/21-01-03-7cac0a780f7906f614cfff3bb5e436e6.png-wm)

### 优化建议

![image](https://static.lovedata.net/21-01-03-ed3db98556afb58e8ce727f98dabcb4b.png-wm)

## 垃圾回收器总结

![image](https://static.lovedata.net/21-01-03-276b383906f0c5211c9f70519acecd0c.png-wm)

### 发展阶段

![image](https://static.lovedata.net/21-01-03-87eed301140db5b310e7b3aa072a8be3.png-wm)

### 如何选择

![image](https://static.lovedata.net/21-01-03-e7350fcfec4dadb565c0d2899ac17d36.png-wm)

![image](https://static.lovedata.net/21-01-03-c684a5ddc10b6333a962d3463d160f87.png-wm)

### 面试

面试官需要循序渐进，从理论、实践各种角度深入

![image](https://static.lovedata.net/21-01-03-e60732e2d28012975e7f3715ba9eaae7.png-wm)

## GC日志分析

![image](https://static.lovedata.net/21-01-03-cf08ebe01fbf39220fe164bf32684331.png-wm)

### Prin tGC

![image](https://static.lovedata.net/21-01-03-858e6a50528d128e9f4dd55495ae8813.png-wm)



> Allocation Failure 分配失败，主要是指新生代，在分配对象到Eden区的时候，空间不足出发的GC



### PringGCDetails

![image](https://static.lovedata.net/21-01-03-9f1cce003e3b359c22a696ff6be1e03f.png-wm)

### PrintTimeStamps,PrintDateStamps

![image](https://static.lovedata.net/21-01-03-0531b9cada9fe86dd063ae5ab6f3c809.png-wm)



### GC日志补充说明

![image](https://static.lovedata.net/21-01-03-9242bfce4d7961d3e7634a35cb44ea7b.png-wm)

![image](https://static.lovedata.net/21-01-03-f2bccc0887fb5d6439ab7af34c6ce86b.png-wm)

![image](https://static.lovedata.net/21-01-03-f46778b97c0db4f0fa6ad0cf82c2d669.png-wm)

#### 新生代

![image](https://static.lovedata.net/21-01-03-4614cf7fdb48c83661a43575ab5c431c.png-wm)

#### 老年代

![image](https://static.lovedata.net/21-01-03-9e9a18c86b3aaefe79cb5cbd534867a3.png-wm)



### GC log 测试

#### JDK7

![image](https://static.lovedata.net/21-01-03-d567bacb1d25aecc4900a11b57beb4b9.png-wm)

![image](https://static.lovedata.net/21-01-03-3cff6d00c12e2695840e180139e7e3a4.png-wm)

![image](https://static.lovedata.net/21-01-03-c436008d294a7de62f5617a8472e6006.png-wm)

![image](https://static.lovedata.net/21-01-03-2260fda1e926d181abdd9a3fd5398d5d.png-wm)

#### jdk8

![image](https://static.lovedata.net/21-01-03-c316d6e3e87ad647432efdca044b73f4.png-wm)

在JDK7中，如果新生代存不下，则会进行垃圾回收，把那几个2mb的对象移动到老年代，然后存入，而在jdk8中，则大对象直接进入到老年代了。

![image](https://static.lovedata.net/21-01-03-a34bf9a2a71763bac8e60938556b5018.png-wm)



### GC日志分析工具

![image](https://static.lovedata.net/21-01-03-8d3023eabf985a37e96be47280ede008.png-wm)



### Xloggc

![image](https://static.lovedata.net/21-01-03-947937dee10235c0887092ec8c96cfca.png-wm)

## 垃圾回收器的新发展

![image](https://static.lovedata.net/21-01-03-835344c64f89953172ce4280ae13bee5.png-wm)



### jdk11新特性

![image](https://static.lovedata.net/21-01-03-4409601bde9a215efda886ae8b77fb01.png-wm)



### zgc

![image](https://static.lovedata.net/21-01-03-3152cb556739cdfb9343b4a9198a2e7d.png-wm)

![image](https://static.lovedata.net/21-01-03-a7ec2857eabfd049dd5a29eaf03ddc06.png-wm)



## 最后寄语

![image](https://static.lovedata.net/21-01-03-9a9db9166ca2d038b509f981b9e4e47e.png-wm)
# 第二章、字节码指令集与解析举例

[toc]

## 概述

![image](https://static.lovedata.net/21-01-10-e8b3de58b6f8d62492b72abd7d84cfa8.png-wm)

### 执行模型

![image](https://static.lovedata.net/21-01-10-c283e8f2e2454759f71ac005b4ba954c.png-wm)

### 字节码与数据类型

![image](https://static.lovedata.net/21-01-10-ba93e526d55c3ce9434b7b8611eb3cef.png-wm)

### 指令分类

![image](https://static.lovedata.net/21-01-10-2051bedac32bdd43003ca8def7daf91a.png-wm)

## 加载与存储指令

![image](https://static.lovedata.net/21-01-10-8b55620d4c2e9786d60f94339c23c83d.png-wm)

![image](https://static.lovedata.net/21-01-10-f75c80eec3f445944fdc977acbebfa56.png-wm)

### 复习：再谈操作数栈与局部变量表

#### 操作数栈

![image](https://static.lovedata.net/21-01-10-581e32f5f519b9e2b603fc6698cad208.png-wm)

#### 局部变量表

![image](https://static.lovedata.net/21-01-10-5e4e08b036d54a572dcda7de45105d73.png-wm)

![image](https://static.lovedata.net/21-01-10-406444a3d10c1c60d460655b36148af5.png-wm)

### 局部变量入栈指令

![image](https://static.lovedata.net/21-01-10-f423054b5f9acf9adb69a0a6d16dd531.png-wm)

```java
//1.局部变量压栈指令
    public void load(int num, Object obj,long count,boolean flag,short[] arr) {
        System.out.println(num);
        System.out.println(obj);
        System.out.println(count);
        System.out.println(flag);
        System.out.println(arr);
    }
```

> count是long类型，占用两个slot

![image](https://static.lovedata.net/21-01-10-119b5a3dfd6bd40bc5e2aa3a3398578b.png-wm)



![image](https://static.lovedata.net/21-01-10-7cc1d7a80cb7f3f34d8fd8a021065dd1.png-wm)



### 常量入栈指令

![image](https://static.lovedata.net/21-01-10-becf05f11b991c4ce21e4f1a491e2ab4.png-wm)

![image](https://static.lovedata.net/21-01-10-7122b2152282f2fcdc0ab4ff7fd1c5d3.png-wm)

![image](https://static.lovedata.net/21-01-10-2f148ccb07a8b73bce0fcaae025fd111.png-wm)

```java
 //2.常量入栈指令
    public void pushConstLdc() {
        int i = -1;
        int a = 5;
        int b = 6;
        int c = 127;
        int d = 128;
        int e = 32767;
        int f = 32768;
    }
```

```shell
 0 iconst_m1
 1 istore_1
 2 iconst_5
 3 istore_2
 4 bipush 6
 6 istore_3
 7 bipush 127
 9 istore 4
11 sipush 128
14 istore 5
16 sipush 32767
19 istore 6
21 ldc #7 <32768>
23 istore 7
25 return
```

```java
  public void constLdc() {
        long a1 = 1;
        long a2 = 2;
        float b1 = 2;
        float b2 = 3;
        double c1 = 1;
        double c2 = 2;
        Date d = null;

    }
```

![image](https://static.lovedata.net/21-01-10-83c831bb974f35d260add024a68599b9.png-wm)





### 出栈装入局部变量表指令

![image](https://static.lovedata.net/21-01-10-87431f7e29a1cccd81af1bbc8d52ea09.png-wm)



```shell
 //3.出栈装入局部变量表指令
    public void store(int k, double d) {
        int m = k + 2;
        long l = 12;
        String str = "atguigu";
        float f = 10.0F;
        d = 10;
    }
```



![image](https://static.lovedata.net/21-01-10-6895b007d7ec98b2e204eb2c69cb05eb.png-wm)



```java
 public void foo(long l, float f) {
        {
            int i = 0;
        }
        {
            String s = "Hello, World";
        }
    }
```

```bash
0 iconst_0
1 istore 4
3 ldc #19 <Hello, World>
5 astore 4
7 return
```

![image-20210110183328733](/Users/apple/Library/Application Support/typora-user-images/image-20210110183328733.png)

![image](https://static.lovedata.net/21-01-10-d0113eac2edd8f05d8dea422864e2502.png-wm)

## 算术指令

![image](https://static.lovedata.net/21-01-10-a760041544c15aeaf3c5339299337a6b.png-wm)

![image](https://static.lovedata.net/21-01-10-9aa9382656775388a27cffa145c1563f.png-wm)

![image](https://static.lovedata.net/21-01-10-fc85044683d3ae1ec98c667ca15df400.png-wm)

### 所有算数指令

![image](https://static.lovedata.net/21-01-10-b8fc0577213c159587cca6bc1c2a7635.png-wm)

Method1

```java
    public void method2(){
        float i = 10;
        float j = -i;
        i = -j;
    }

```

```bash
0 ldc #4 <10.0>
2 fstore_1
3 fload_1
4 fneg
5 fstore_2
6 fload_2
7 fneg
8 fstore_1
9 return
```

---

method3

![image](https://static.lovedata.net/21-01-10-3e072ea7ef57b7d14f2af9d48a417ce0.png-wm)

![image](https://static.lovedata.net/21-01-10-86cd4464b20dab4eae8cfcd11452c982.png-wm)

---

method4



![image](https://static.lovedata.net/21-01-11-4ef7dca60f8163e79caec9b871f99ab6.png-wm)



method5

![image](https://static.lovedata.net/21-01-11-510f75c2b42945cf7e238ab744e81f96.png-wm)



#### 举例

![image](https://static.lovedata.net/21-01-11-3cefc47d4c9b29f6a21218bf334e6ca7.png-wm)

![image](https://static.lovedata.net/21-01-11-50f3c95e957f6940ddd368509e891e61.png-wm)

#### 曾经的案例1

![image](https://static.lovedata.net/21-01-11-5166270beb4607678e5a99d7457e4699.png-wm)

![image](https://static.lovedata.net/21-01-11-5356a7351356b614ac08ef2ffed3a9e4.png-wm)

![image](https://static.lovedata.net/21-01-11-b39985b1e0e76d737d340a74bde7556a.png-wm)



#### 曾经的案例2

#### 彻底搞定++运算符号

Method6

> 下面图中，生成的字节码指令一模一样，++i 和 i++ 都一样 ，如果不把这些赋值到一个变量，是一样的。
>
> 所以 for(int i = 0;i<10;i++) 和  for(int i = 0;i<10;++i) 的效果是一模一样的。我去

![image](https://static.lovedata.net/21-01-11-042de62e3f4913ca2b73fcf0bb21537e.png-wm)

![image](https://static.lovedata.net/21-01-11-f524f8466453c35c17c1c7773161ea66.png-wm)



method7 

> 虽然说，单独写 i++ 和 ++i 是一样效果，但是和其他的一起使用，效果就不一样咯

Int b = i++;

下面就是关键  看右边字节码的第三个，首先 iload_1 把本地变量表索引为1的压入栈中，这个时候栈顶是10，然后在 iinc 1 by 1 ,将索引为1的本地变量表的值 +1 ，这个时候了，索引为1的 值就变成了 11了，然后在 istore_2 ,在将当前栈顶的元素（还是为10）放入到 索引为2的地方，**所以 i++ 就是先把 i以前的值赋给左边的变量，再执行++操作**

![image](https://static.lovedata.net/21-01-11-a165e790660aea9e04410c3756a19105.png-wm)



++j 

而++j 就是 先 ++ 然后在复制，请看 字节码，bi push 20 ，放入到栈中，然后 istore_3 放入到索引为3的位置，然后执行 iinc 3 by 1,将索引为3的位置的值 +1  编程 21，在 iload_3 将索引为3的值入栈，存入到 istore_4 ，赋值给b,

![image](https://static.lovedata.net/21-01-11-b051f5ff51213db533544d073ee193a9.png-wm)



method8 

> 因为已经 iload_1 将 i 的值压入栈中，然后执行了 iinc 1 by 1 ，将i的值改为11，然后继续执行 istroe_1 就将 i的值重新有改为10了，所以最后还是10

![image](https://static.lovedata.net/21-01-11-fdc83a9d32c17f8cf331c97c0e202d58.png-wm)



### 比较指令的说明

## 类型转换指令

### 宽化类型转换

### 窄化类型转换



## 对象的创建与访问指令

## 创建指令

### 字段访问指令

### 数组操作指令


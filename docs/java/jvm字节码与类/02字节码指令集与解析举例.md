# 第二章、字节码指令集与解析举例

[toc]

## 概述

![image](https://static.lovedata.net/21-01-10-e8b3de58b6f8d62492b72abd7d84cfa8.png-wm)

### 执行模型

![image](https://static.lovedata.net/21-01-10-c283e8f2e2454759f71ac005b4ba954c.png-wm)

### 字节码与数据类型

![image](https://static.lovedata.net/21-01-10-ba93e526d55c3ce9434b7b8611eb3cef.png-wm)

### 指令分类

![image](https://static.lovedata.net/21-01-10-2051bedac32bdd43003ca8def7daf91a.png-wm)

## 加载与存储指令

![image](https://static.lovedata.net/21-01-10-8b55620d4c2e9786d60f94339c23c83d.png-wm)

![image](https://static.lovedata.net/21-01-10-f75c80eec3f445944fdc977acbebfa56.png-wm)

### 复习：再谈操作数栈与局部变量表

#### 操作数栈

![image](https://static.lovedata.net/21-01-10-581e32f5f519b9e2b603fc6698cad208.png-wm)

#### 局部变量表

![image](https://static.lovedata.net/21-01-10-5e4e08b036d54a572dcda7de45105d73.png-wm)

![image](https://static.lovedata.net/21-01-10-406444a3d10c1c60d460655b36148af5.png-wm)

### 局部变量入栈指令

![image](https://static.lovedata.net/21-01-10-f423054b5f9acf9adb69a0a6d16dd531.png-wm)

```java
//1.局部变量压栈指令
    public void load(int num, Object obj,long count,boolean flag,short[] arr) {
        System.out.println(num);
        System.out.println(obj);
        System.out.println(count);
        System.out.println(flag);
        System.out.println(arr);
    }
```

> count是long类型，占用两个slot

![image](https://static.lovedata.net/21-01-10-119b5a3dfd6bd40bc5e2aa3a3398578b.png-wm)



![image](https://static.lovedata.net/21-01-10-7cc1d7a80cb7f3f34d8fd8a021065dd1.png-wm)



### 常量入栈指令

![image](https://static.lovedata.net/21-01-10-becf05f11b991c4ce21e4f1a491e2ab4.png-wm)

![image](https://static.lovedata.net/21-01-10-7122b2152282f2fcdc0ab4ff7fd1c5d3.png-wm)

![image](https://static.lovedata.net/21-01-10-2f148ccb07a8b73bce0fcaae025fd111.png-wm)

```java
 //2.常量入栈指令
    public void pushConstLdc() {
        int i = -1;
        int a = 5;
        int b = 6;
        int c = 127;
        int d = 128;
        int e = 32767;
        int f = 32768;
    }
```

```shell
 0 iconst_m1
 1 istore_1
 2 iconst_5
 3 istore_2
 4 bipush 6
 6 istore_3
 7 bipush 127
 9 istore 4
11 sipush 128
14 istore 5
16 sipush 32767
19 istore 6
21 ldc #7 <32768>
23 istore 7
25 return
```

```java
  public void constLdc() {
        long a1 = 1;
        long a2 = 2;
        float b1 = 2;
        float b2 = 3;
        double c1 = 1;
        double c2 = 2;
        Date d = null;

    }
```

![image](https://static.lovedata.net/21-01-10-83c831bb974f35d260add024a68599b9.png-wm)





### 出栈装入局部变量表指令

![image](https://static.lovedata.net/21-01-10-87431f7e29a1cccd81af1bbc8d52ea09.png-wm)



```shell
 //3.出栈装入局部变量表指令
    public void store(int k, double d) {
        int m = k + 2;
        long l = 12;
        String str = "atguigu";
        float f = 10.0F;
        d = 10;
    }
```



![image](https://static.lovedata.net/21-01-10-6895b007d7ec98b2e204eb2c69cb05eb.png-wm)



```java
 public void foo(long l, float f) {
        {
            int i = 0;
        }
        {
            String s = "Hello, World";
        }
    }
```

```bash
0 iconst_0
1 istore 4
3 ldc #19 <Hello, World>
5 astore 4
7 return
```

![image-20210110183328733](/Users/apple/Library/Application Support/typora-user-images/image-20210110183328733.png)

![image](https://static.lovedata.net/21-01-10-d0113eac2edd8f05d8dea422864e2502.png-wm)

## 算术指令

![image](https://static.lovedata.net/21-01-10-a760041544c15aeaf3c5339299337a6b.png-wm)

![image](https://static.lovedata.net/21-01-10-9aa9382656775388a27cffa145c1563f.png-wm)

![image](https://static.lovedata.net/21-01-10-fc85044683d3ae1ec98c667ca15df400.png-wm)

### 所有算数指令

![image](https://static.lovedata.net/21-01-10-b8fc0577213c159587cca6bc1c2a7635.png-wm)

Method1

```java
    public void method2(){
        float i = 10;
        float j = -i;
        i = -j;
    }

```

```bash
0 ldc #4 <10.0>
2 fstore_1
3 fload_1
4 fneg
5 fstore_2
6 fload_2
7 fneg
8 fstore_1
9 return
```

---

method3

![image](https://static.lovedata.net/21-01-10-3e072ea7ef57b7d14f2af9d48a417ce0.png-wm)

![image](https://static.lovedata.net/21-01-10-86cd4464b20dab4eae8cfcd11452c982.png-wm)

---

method4



![image](https://static.lovedata.net/21-01-11-4ef7dca60f8163e79caec9b871f99ab6.png-wm)



method5

![image](https://static.lovedata.net/21-01-11-510f75c2b42945cf7e238ab744e81f96.png-wm)



#### 举例

![image](https://static.lovedata.net/21-01-11-3cefc47d4c9b29f6a21218bf334e6ca7.png-wm)

![image](https://static.lovedata.net/21-01-11-50f3c95e957f6940ddd368509e891e61.png-wm)

#### 曾经的案例1

![image](https://static.lovedata.net/21-01-11-5166270beb4607678e5a99d7457e4699.png-wm)

![image](https://static.lovedata.net/21-01-11-5356a7351356b614ac08ef2ffed3a9e4.png-wm)

![image](https://static.lovedata.net/21-01-11-b39985b1e0e76d737d340a74bde7556a.png-wm)



#### 曾经的案例2

#### 彻底搞定++运算符号

Method6

> 下面图中，生成的字节码指令一模一样，++i 和 i++ 都一样 ，如果不把这些赋值到一个变量，是一样的。
>
> 所以 for(int i = 0;i<10;i++) 和  for(int i = 0;i<10;++i) 的效果是一模一样的。我去

![image](https://static.lovedata.net/21-01-11-042de62e3f4913ca2b73fcf0bb21537e.png-wm)

![image](https://static.lovedata.net/21-01-11-f524f8466453c35c17c1c7773161ea66.png-wm)



method7 

> 虽然说，单独写 i++ 和 ++i 是一样效果，但是和其他的一起使用，效果就不一样咯

Int b = i++;

下面就是关键  看右边字节码的第三个，首先 iload_1 把本地变量表索引为1的压入栈中，这个时候栈顶是10，然后在 iinc 1 by 1 ,将索引为1的本地变量表的值 +1 ，这个时候了，索引为1的 值就变成了 11了，然后在 istore_2 ,在将当前栈顶的元素（还是为10）放入到 索引为2的地方，**所以 i++ 就是先把 i以前的值赋给左边的变量，再执行++操作**

![image](https://static.lovedata.net/21-01-11-a165e790660aea9e04410c3756a19105.png-wm)



++j 

而++j 就是 先 ++ 然后在复制，请看 字节码，bi push 20 ，放入到栈中，然后 istore_3 放入到索引为3的位置，然后执行 iinc 3 by 1,将索引为3的位置的值 +1  编程 21，在 iload_3 将索引为3的值入栈，存入到 istore_4 ，赋值给b,

![image](https://static.lovedata.net/21-01-11-b051f5ff51213db533544d073ee193a9.png-wm)



method8 

> 因为已经 iload_1 将 i 的值压入栈中，然后执行了 iinc 1 by 1 ，将i的值改为11，然后继续执行 istroe_1 就将 i的值重新有改为10了，所以最后还是10

![image](https://static.lovedata.net/21-01-11-fdc83a9d32c17f8cf331c97c0e202d58.png-wm)



### 比较指令的说明

![image](https://static.lovedata.net/21-01-12-1f2550ee34f2ab81e51900c4d2d9638d.png-wm)

## 类型转换指令

![image](https://static.lovedata.net/21-01-12-84d0f7e96e42b9a7d273a9be341c396b.png-wm)

### 宽化类型转换

![image](https://static.lovedata.net/21-01-12-a83739cd9fdc6a40dfb2db472a859efa.png-wm)

![image](https://static.lovedata.net/21-01-12-41dcd9f3fe176ed2dc68a11952de90b6.png-wm)

![image](https://static.lovedata.net/21-01-12-75198e3fce906b20f4c61bf9a106f581.png-wm)

#### 

#### 精度损失问题

> int 是四个字节。long 是八个字节， float 是四个字节 double 是八个字节

![image](https://static.lovedata.net/21-01-12-d8edf5f94350b5e2a5bce45e5ae15b5e.png-wm)

>  这个时候没有发生精度损失问题，数值不够大 double 是双精度，精度更高一些

![image](https://static.lovedata.net/21-01-12-43cecc94d08183f6c2c6de843a0649a7.png-wm)

![image](https://static.lovedata.net/21-01-12-6786c1191ece5be05d71a1fe9a91c50c.png-wm)



![image](https://static.lovedata.net/21-01-12-77c4711279e83449c2a029cf26175f13.png-wm)



![image](https://static.lovedata.net/21-01-12-53ce13af4187817958880dc617afa68d.png-wm)

### 窄化类型转换

![image](https://static.lovedata.net/21-01-12-e39311ac8b46162c89edbb1b71e7a670.png-wm)

![image](https://static.lovedata.net/21-01-12-be36bb538cb1c32b50aa7d3c95faa98c.png-wm)

![image](https://static.lovedata.net/21-01-12-1ba2afd5a56a2d60f166a31ce3079ce6.png-wm)



![image](https://static.lovedata.net/21-01-12-8594eef3af5912d73bfd10669e0f9180.png-wm)

#### 精度损失问题

> byte最大只是 127 

![image](https://static.lovedata.net/21-01-12-87c39ad446c2064b91ad53aeabb84475.png-wm)

#### 

![image](https://static.lovedata.net/21-01-12-5d030f3b2da7ba6d71c57b97d3c3c6ab.png-wm)

![image](https://static.lovedata.net/21-01-12-ea27780ca094593b5585811e43ceeb23.png-wm)



![image](https://static.lovedata.net/21-01-13-537c4a5b77793db2f2076c0d6f9b9c43.png-wm)



![image](https://static.lovedata.net/21-01-13-3e7a394c6bca57abe8abead3757b87b1.png-wm)



## 对象的创建与访问指令

![image](https://static.lovedata.net/21-01-13-c9f7e43bfc8484a3a471b95787ba3c67.png-wm)

### 创建指令

![image](https://static.lovedata.net/21-01-13-81072d9b06d5c464725875e31d66ab43.png-wm)

![image](https://static.lovedata.net/21-01-13-10ecf70525e7ed2d9a30f71e3851ce27.png-wm)



![image](https://static.lovedata.net/21-01-13-464d8c65558ad9ee13c6b48de067ca10.png-wm)



### 字段访问指令

![image](https://static.lovedata.net/21-01-13-a3b20f13d9fc69cca436cdb76800b3a0.png-wm)



![image](https://static.lovedata.net/21-01-13-b3431e8a7443f5b402a48f15a1c10e7a.png-wm)

![image](https://static.lovedata.net/21-01-13-cff2b6fe3c044553dda5e9c051658c5b.png-wm)

![image](https://static.lovedata.net/21-01-13-a50889674fdf201d50ef1ed72e641b98.png-wm)

![image](https://static.lovedata.net/21-01-13-34cc872b707d61cd1af5aadc022333f7.png-wm)

![image](https://static.lovedata.net/21-01-13-3072e24b397062b764acb48f3dc5850e.png-wm)

### 数组操作指令

![image](https://static.lovedata.net/21-01-13-7b52d2801b19f9828655281e584ce26c.png-wm)

![image](https://static.lovedata.net/21-01-14-daf00fa0a4858bc8a2b88a6c719b516f.png-wm)

![image](https://static.lovedata.net/21-01-14-082ece697b06bc70054527d7be1d0f57.png-wm)

#### boolean类型数组

![image](https://static.lovedata.net/21-01-14-41f94553ed6cc96758880bb886985678.png-wm)



![image](https://static.lovedata.net/21-01-14-865c028abeb1ec9c182d43a868744f56.png-wm)

### 类型检查指令

![image](https://static.lovedata.net/21-01-14-2eb0eb628cf238ff8ae9df11645a0313.png-wm)



![image](https://static.lovedata.net/21-01-14-a4c837c607200e83df18df5772ea7232.png-wm)



## 方法调用与返回指令

### 方法调用指令

![image](https://static.lovedata.net/21-01-14-a1b30b43c5e744038bfd33c7f5a80c02.png-wm)

#### invokespecial

![image](https://static.lovedata.net/21-01-14-fc959fbc57c52bfce4623a44ef8e23fe.png-wm)

![image](https://static.lovedata.net/21-01-14-0b61657326f683c6b4bcaae1c7f6bba8.png-wm)



#### invokestatic

![image](https://static.lovedata.net/21-01-14-28bbdc8444f026df8db956dc6521e21e.png-wm)

![image](https://static.lovedata.net/21-01-14-b78110ba7ce6b1f9a9e365b82b09352b.png-wm)



#### invokeinterface

![image](https://static.lovedata.net/21-01-14-dd6e3c8c4d0bca9ec2ae671904dc9dc6.png-wm)

### 

#### invokevitual

![image](https://static.lovedata.net/21-01-14-4e93382944fab7911a23fc2da0d9fd80.png-wm)

### 方法返回指令

![image](https://static.lovedata.net/21-01-15-caf1135f2b2fadb276b530f56484bcb5.png-wm)

![image](https://static.lovedata.net/21-01-15-8cd907ef594b65fed7b0d3bd5649890a.png-wm)



#### ireturn

![image](https://static.lovedata.net/21-01-15-52c498665c734f1ece630ddb4ba5c0c0.png-wm)



#### freturn

![image](https://static.lovedata.net/21-01-15-3f334300772de3a1f5af36089bb83dcc.png-wm)



#### ireturn

![image](https://static.lovedata.net/21-01-15-b208b71f2f94a33d435aa4a8f0b7adb3.png-wm)



#### 方法调用

![image](https://static.lovedata.net/21-01-15-3952bbc64af18242cec7f063ab650feb.png-wm)



## 操作数栈管理指令

![image](https://static.lovedata.net/21-01-15-17c5eb879697c032f42532ba80556fc3.png-wm)

![image](https://static.lovedata.net/21-01-15-2b566034ad24793afb1d5d8d2eb112de.png-wm)

### dup

![image](https://static.lovedata.net/21-01-15-1777bb12a64797ac4909bc00229a6aa4.png-wm)

### Pop

> 不在赋值，直接 obj.tostring  因为 这个obj.tostring 没有使用，所以就直接pop了，因为引用类型占用一个slot，所以是pop，如果是long double 则会pop2

![image](https://static.lovedata.net/21-01-15-6e21563556ee3a0bf271e8f75fee37fb.png-wm)



### pop2

![image](https://static.lovedata.net/21-01-15-9c5171f4a021d2ff8ebdcf0e7f0764b9.png-wm)



### dup2

> long类型2个slot，下面方法，nextIndex 返回值还是0 因为 index++ 是先赋值，后返回，index会变成1
>
> 1. 第一步先将this入栈
> 2. 然后dup 复制一份出来
> 3. 调用 getfield 获取index
> 4. 因为long是2个slot 所以 dup2_x1 是将当前栈 复制一份出来，然后插入到当前位置向下数3个slot的位置，也就是栈的地步
> 5. 然后将常量1压入栈
> 6. 再将  现在处于栈顶 index 0 加1 
> 7. 然后调用putfield 将 index 赋值为1 此时就会弹出
> 8. 再返回栈底的 index 0 

![image](https://static.lovedata.net/21-01-15-e8706df628419cb86769d0b7b296c173.png-wm)



## 控制转移指令

![image](https://static.lovedata.net/21-01-15-58c5a573002f7868bfd05aa64efad1d2.png-wm)



### 条件跳转指令

![image](https://static.lovedata.net/21-01-15-8866cf9965da619fd03f1b7af3ccd0ae.png-wm)



![image](https://static.lovedata.net/21-01-15-a4c67f716ab97efe0ce02267ae8f380c.png-wm)



![image](https://static.lovedata.net/21-01-18-1dd01dd5dc92472bfd9e0e3bd3d57625.png-wm)



#### 和null进行比较

![image](https://static.lovedata.net/21-01-18-da3acbb0a3fa76f13cf34bf886c9dd48.png-wm)



#### compare

Float

![image](https://static.lovedata.net/21-01-18-4b8b057c91baee77238d23da123260c7.png-wm)



int 和long

![image](https://static.lovedata.net/21-01-18-fcda85cbf26281f1f55ec30652cfb6ad.png-wm)

double

![image](https://static.lovedata.net/21-01-18-b38dde03f8c5caefdde316649f8f7873.png-wm)



### 比较条件跳转指令

![image](https://static.lovedata.net/21-01-18-62694b24288efde784b0d4e9ee4540b8.png-wm)





![image](https://static.lovedata.net/21-01-18-7f9c2f101f1732a443cf60e02f0e4616.png-wm)

short 和 byte

![image](https://static.lovedata.net/21-01-18-07c60bf447866d561917351cf77602a8.png-wm)

object

```java
   public void ifCompare3() {
        Object obj1 = new Object();
        Object obj2 = new Object();
        System.out.println(obj1 == obj2);//false
        System.out.println(obj1 != obj2);//true
    }
```

```shell
 0 new #10 <java/lang/Object>
 3 dup
 4 invokespecial #1 <java/lang/Object.<init>>
 7 astore_1
 8 new #10 <java/lang/Object>
11 dup
12 invokespecial #1 <java/lang/Object.<init>>
15 astore_2
16 getstatic #4 <java/lang/System.out>
19 aload_1
20 aload_2
21 if_acmpne 28 (+7)
24 iconst_1
25 goto 29 (+4)
28 iconst_0
29 invokevirtual #5 <java/io/PrintStream.println>
32 getstatic #4 <java/lang/System.out>
35 aload_1
36 aload_2
37 if_acmpeq 44 (+7)
40 iconst_1
41 goto 45 (+4)
44 iconst_0
45 invokevirtual #5 <java/io/PrintStream.println>
48 return
```





### 多条件分支跳转

![image](https://static.lovedata.net/21-01-18-982a76461f536a4b504b0479ed87d0fe.png-wm)

![image](https://static.lovedata.net/21-01-18-e4f0b702d8684c005954a28aaf79c078.png-wm)

![image](https://static.lovedata.net/21-01-18-cd2e31c2504407327a464e2f68752248.png-wm)

ta b leswitch

![image](https://static.lovedata.net/21-01-18-e3c23ad19a4bb9139824f14924ff58e7.png-wm)

#### 没有break的情况，直接往下走

![image](https://static.lovedata.net/21-01-18-6c1a343e288699aa6ad47ad692168046.png-wm)



Lookup switch

![image](https://static.lovedata.net/21-01-19-135640a3a52375d579331066be7a04fe.png-wm)

String

使用hashcode 对比，然后再使用 eqauls对比

![image](https://static.lovedata.net/21-01-19-6b49874862c9f54fc09890f53b9f1ff7.png-wm)



### 无条件跳转

> 主要goto，下面几个 jsr 很少见，了解就行了。

![image](https://static.lovedata.net/21-01-19-4423d6a1b9fab54b6d1ba6fa7cd13173.png-wm)

int

![image](https://static.lovedata.net/21-01-19-0c0f6a5999c0ceb05893a49736101107.png-wm)

double

![image](https://static.lovedata.net/21-01-19-c611eb9330c0f6f7eb73c0eef4ac9ee3.png-wm)

short

![image](https://static.lovedata.net/21-01-19-720acba3f92bdfa25ea5c6731fd9d510.png-wm)



#### 思考 while循环和for循环的区别

> 字节码层面一模一样

![image](https://static.lovedata.net/21-01-19-5cc15cd5e2524ffe2314cb1fd09c53d2.png-wm)





> Do while 和 for循环的区别，do while 至少会执行一次，而for循环不一定会执行

![image](https://static.lovedata.net/21-01-19-45438dad5925de1df5b9e2e11d2913b3.png-wm)



## 异常处理指令

### 抛出异常

![image](https://static.lovedata.net/21-01-19-affcf6e6c699fb613e7261d20e544473.png-wm)
![image](https://static.lovedata.net/21-01-19-681049cb66318ea076bf9b50c45170ff.png-wm)
![image](https://static.lovedata.net/21-01-19-73d8001ec04797944331d8f2ce2766ae.png-wm)

![image](https://static.lovedata.net/21-01-19-1a38900920cb0602d65f63f50e72842d.png-wm)
![image](https://static.lovedata.net/21-01-19-2f5490cad922a19da824d6decb02bb1b.png-wm)

> 除数为0的情况，这种情况，是系统内部定义好的异常，不会出现athorw

![image](https://static.lovedata.net/21-01-19-896ad18d555cdb02cc1f4b4af3107b1b.png-wm)



### 异常处理与异常表
![image](https://static.lovedata.net/21-01-19-8f0ad861af68c5ebecb46eacb65209e0.png-wm)

![image](https://static.lovedata.net/21-01-20-797dba7a0730b6c6b1bd45c07106f043.png-wm)

![image](https://static.lovedata.net/21-01-20-dc9a0f39e3b11a3703dfc994fe45e50a.png-wm)

#### 思考题

![image](https://static.lovedata.net/21-01-20-9c5171f4a021d2ff8ebdcf0e7f0764b9.png-wm)

## 同步控制指令
![image](https://static.lovedata.net/21-01-20-160ef15992950dc14407df9950541008.png-wm)

### 方法同步指令
![image](https://static.lovedata.net/21-01-20-d53d47ef5875e295d714ae929c1999b6.png-wm)
![image](https://static.lovedata.net/21-01-20-c27424c961de1ef2d643b3d0777578fa.png-wm)

![image](https://static.lovedata.net/21-01-20-863604712264b16eb50d8a1e8d9d6e22.png-wm)



> 同步方法，同步不会体现在字节码中，而是体现在方法的访问标示中

![image](https://static.lovedata.net/21-01-20-1f9c7b2e33ffd538ce2073dfdbf41502.png-wm)

###  方法内指定指令序列同步

![image](https://static.lovedata.net/21-01-20-3383ded9fb010745fcf55ed64ded7438.png-wm)
![image](https://static.lovedata.net/21-01-20-3e4af776d6ad0378fd526ad9c4f7e751.png-wm)

![image](https://static.lovedata.net/21-01-20-117c3a7c5808e911f99ad4dee2d3aea9.png-wm)


![image](https://static.lovedata.net/21-01-20-58c5a573002f7868bfd05aa64efad1d2.png-wm)
![image](https://static.lovedata.net/21-01-20-ca316f8fed771259bf3b05ef4892c8fa.png-wm)

![image](https://static.lovedata.net/21-01-20-2f95b46ee088442ad68a12324f83936e.png-wm)


![image](https://static.lovedata.net/21-01-20-327daf736da07d8740121f8797c86bb4.png-wm)
![image](https://static.lovedata.net/21-01-20-03effcfe1dd1b39d4f3288f1ef916c8a.png-wm)
![image](https://static.lovedata.net/21-01-20-f4728bcd6a1ddc6b49b3a26deb0915be.png-wm)




